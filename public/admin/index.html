<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script>
    (() => {
      const endpoint =
        "http://127.0.0.1:7243/ingest/81df2ba7-2f20-433b-96d5-3a4a1746016e";
      const sendLog = (payload) => {
        fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        }).catch(() => {});
      };

      // #region agent log
      sendLog({
        sessionId: "debug-session",
        runId: "run1",
        hypothesisId: "C",
        location: "public/admin/index.html:13",
        message: "Admin page load",
        data: {
          href: window.location.href,
          origin: window.location.origin,
          pathname: window.location.pathname,
        },
        timestamp: Date.now(),
      });
      // #endregion

      const basePath = window.location.pathname.replace(/\/admin\/?$/, "/");
      const cmsConfigPath = `${basePath}admin/config.yml`;
      window.CMS_MANUAL_INIT = true;
      window.CMS_CONFIG_PATH = cmsConfigPath;

      // #region agent log
      sendLog({
        sessionId: "debug-session",
        runId: "run1",
        hypothesisId: "A",
        location: "public/admin/index.html:34",
        message: "Computed CMS config path",
        data: { basePath, cmsConfigPath },
        timestamp: Date.now(),
      });
      // #endregion

      const extractParamKeys = (input) => {
        if (!input) return [];
        try {
          return Array.from(new URLSearchParams(input).keys());
        } catch {
          return [];
        }
      };

      const logLocationChange = (message) => {
        const hash = window.location.hash || "";
        const hashQuery = hash.includes("?") ? hash.split("?")[1] : "";
        // #region agent log
        sendLog({
          sessionId: "debug-session",
          runId: "run1",
          hypothesisId: "D",
          location: "public/admin/index.html:58",
          message,
          data: {
            pathname: window.location.pathname,
            searchKeys: extractParamKeys(window.location.search),
            hashKeys: extractParamKeys(hashQuery),
          },
          timestamp: Date.now(),
        });
        // #endregion
      };

      window.addEventListener("hashchange", () =>
        logLocationChange("Hash changed"),
      );
      window.addEventListener("popstate", () =>
        logLocationChange("History changed"),
      );

      document.addEventListener("click", (event) => {
        let node = event.target;
        while (node && node !== document.body) {
          if (node.tagName === "A" && node.href) {
            const href = node.href;
            const isAuth =
              href.includes("api.netlify.com/auth") ||
              href.includes("github.com") ||
              href.includes("oauth");
            if (isAuth) {
              // #region agent log
              sendLog({
                sessionId: "debug-session",
                runId: "run1",
                hypothesisId: "E",
                location: "public/admin/index.html:84",
                message: "Auth link click",
                data: {
                  href,
                  tagName: node.tagName,
                  id: node.id || null,
                },
                timestamp: Date.now(),
              });
              // #endregion
            }
            break;
          }
          node = node.parentElement;
        }
      });

      window.addEventListener("message", (event) => {
        // #region agent log
        sendLog({
          sessionId: "debug-session",
          runId: "run1",
          hypothesisId: "F",
          location: "public/admin/index.html:102",
          message: "Window message event",
          data: {
            origin: event.origin,
            dataType: typeof event.data,
          },
          timestamp: Date.now(),
        });
        // #endregion
      });

      const originalFetch = window.fetch.bind(window);
      const originalOpen = window.open.bind(window);
      window.open = (url, name, features) => {
        const safeUrl = typeof url === "string" ? url : "";
        const isAuth =
          safeUrl.includes("api.netlify.com/auth") ||
          safeUrl.includes("github.com") ||
          safeUrl.includes("oauth");
        if (isAuth) {
          // #region agent log
          sendLog({
            sessionId: "debug-session",
            runId: "run1",
            hypothesisId: "E",
            location: "public/admin/index.html:52",
            message: "window.open auth",
            data: { url: safeUrl },
            timestamp: Date.now(),
          });
          // #endregion
        }
        return originalOpen(url, name, features);
      };
      window.fetch = (input, init) => {
        const url = typeof input === "string" ? input : input?.url || "";
        const isAuthUrl =
          url.includes("api.netlify.com/auth") ||
          url.includes("github.com/login/oauth") ||
          url.includes("/.netlify/");
        if (isAuthUrl) {
          // #region agent log
          sendLog({
            sessionId: "debug-session",
            runId: "run1",
            hypothesisId: "B",
            location: "public/admin/index.html:37",
            message: "Auth fetch request",
            data: { url, method: init?.method || "GET" },
            timestamp: Date.now(),
          });
          // #endregion
        }
        return originalFetch(input, init).then((response) => {
          if (isAuthUrl) {
            // #region agent log
            sendLog({
              sessionId: "debug-session",
              runId: "run1",
              hypothesisId: "B",
              location: "public/admin/index.html:51",
              message: "Auth fetch response",
              data: { url, status: response.status },
              timestamp: Date.now(),
            });
            // #endregion
          }
          return response;
        });
      };

      const configUrl = cmsConfigPath;
      // #region agent log
      sendLog({
        sessionId: "debug-session",
        runId: "run1",
        hypothesisId: "A",
        location: "public/admin/index.html:69",
        message: "Config fetch attempt",
        data: { url: configUrl },
        timestamp: Date.now(),
      });
      // #endregion
      originalFetch(configUrl)
        .then((response) => {
          // #region agent log
          sendLog({
            sessionId: "debug-session",
            runId: "run1",
            hypothesisId: "A",
            location: "public/admin/index.html:82",
            message: "Config fetch response",
            data: { url: configUrl, status: response.status },
            timestamp: Date.now(),
          });
          // #endregion
          return response.text();
        })
        .then((text) => {
          const pick = (key) => {
            const match = text.match(
              new RegExp(`^\\s*${key}\\s*:\\s*(.+)$`, "m"),
            );
            return match ? match[1].replace(/["']/g, "").trim() : null;
          };
          // #region agent log
          sendLog({
            sessionId: "debug-session",
            runId: "run1",
            hypothesisId: "A",
            location: "public/admin/index.html:74",
            message: "Config snapshot",
            data: {
              backend: pick("name"),
              authType: pick("auth_type"),
              appId: pick("app_id"),
              repo: pick("repo"),
              siteUrl: pick("site_url"),
              baseUrl: pick("base_url"),
              authEndpoint: pick("auth_endpoint"),
            },
            timestamp: Date.now(),
          });
          // #endregion
        })
        .catch(() => {});
    })();
  </script>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js" defer></script>
  <script>
    // #region agent log
    fetch("http://127.0.0.1:7243/ingest/81df2ba7-2f20-433b-96d5-3a4a1746016e", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        sessionId: "debug-session",
        runId: "run1",
        hypothesisId: "B",
        location: "public/admin/index.html:118",
        message: "CMS init hook",
        data: { cmsConfigPath: window.CMS_CONFIG_PATH || null },
        timestamp: Date.now(),
      }),
    }).catch(() => {});
    // #endregion
    window.addEventListener("load", () => {
      // #region agent log
      fetch("http://127.0.0.1:7243/ingest/81df2ba7-2f20-433b-96d5-3a4a1746016e", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId: "debug-session",
          runId: "run1",
          hypothesisId: "B",
          location: "public/admin/index.html:127",
          message: "Window load CMS presence",
          data: { hasCMS: !!window.CMS },
          timestamp: Date.now(),
        }),
      }).catch(() => {});
      // #endregion

      if (window.CMS && window.CMS_MANUAL_INIT) {
        // #region agent log
        fetch("http://127.0.0.1:7243/ingest/81df2ba7-2f20-433b-96d5-3a4a1746016e", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId: "debug-session",
            runId: "run1",
            hypothesisId: "B",
            location: "public/admin/index.html:136",
            message: "Calling CMS.init",
            data: { configPath: window.CMS_CONFIG_PATH || null },
            timestamp: Date.now(),
          }),
        }).catch(() => {});
        // #endregion
        window.CMS.init();
      }

      const config =
        window.CMS?.config ||
        (typeof window.CMS?.getConfig === "function"
          ? window.CMS.getConfig()
          : null);

      // #region agent log
      fetch("http://127.0.0.1:7243/ingest/81df2ba7-2f20-433b-96d5-3a4a1746016e", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId: "debug-session",
          runId: "run1",
          hypothesisId: "B",
          location: "public/admin/index.html:150",
          message: "CMS config after init",
          data: {
            configPresent: !!config,
            backend: config?.backend || null,
            cmsKeys: window.CMS ? Object.keys(window.CMS) : [],
          },
          timestamp: Date.now(),
        }),
      }).catch(() => {});
      // #endregion
    });
  </script>
</head>
<body>
  <!-- CMS mounts into the body automatically -->
</body>
</html>
